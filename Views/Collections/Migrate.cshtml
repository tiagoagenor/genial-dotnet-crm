@model genial_dotnet_crm.Models.Collection
@{
    ViewData["Title"] = "Migrate Collection";
    Layout = "_DashboardLayout";
    var stagesList = ViewData["Stages"] as List<genial_dotnet_crm.Models.Stage> ?? new List<genial_dotnet_crm.Models.Stage>();
    var currentStageKey = ViewData["CurrentStage"]?.ToString() ?? "hml";
    var currentStageObj = stagesList.FirstOrDefault(s => s.Key == currentStageKey);
}
@Html.AntiForgeryToken()

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-16 bg-gray-50 border-r border-gray-200 flex flex-col">
        <!-- Top Section with Icons -->
        <div class="flex flex-col h-full">
            <div class="p-3 border-b border-gray-200">
                <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center text-white font-bold text-xs">
                    PB
                </div>
            </div>
            
            <div class="flex flex-col items-center py-4 gap-4">
                <!-- Collections -->
                <a asp-action="Index" asp-controller="Collections" class="relative group">
                    <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-100">
                        <i class="fas fa-database text-gray-700"></i>
                    </div>
                    <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50">
                        Collections
                        <div class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900"></div>
                    </div>
                </a>
                <!-- Logs -->
                <a asp-action="Logs" asp-controller="Collections" class="relative group">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-200">
                        <i class="fas fa-list-ul text-gray-600"></i>
                    </div>
                    <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50">
                        Logs
                        <div class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900"></div>
                    </div>
                </a>
                <!-- Settings -->
                <a asp-action="Settings" asp-controller="Collections" class="relative group">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-200">
                        <i class="fas fa-code text-gray-600"></i>
                    </div>
                    <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50">
                        Settings
                        <div class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900"></div>
                    </div>
                </a>
            </div>

            <!-- Stage Selector -->
            <div class="mt-auto p-3 border-t border-gray-200">
                <div class="relative group">
                    <div id="stageSelector" class="w-10 h-10 border-2 border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-gray-400 transition-colors">
                        <span id="stageLetter" class="text-gray-700 font-bold text-sm">@(currentStageObj?.Letter ?? "H")</span>
                    </div>
                    <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50">
                        <span id="stageTooltip">@(currentStageObj?.Label ?? "HML")</span>
                        <div class="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900"></div>
                    </div>
                </div>
            </div>

            <!-- Bottom User Avatar -->
            <div class="p-3">
                <div class="relative group">
                    <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-medium cursor-pointer">
                        @(ViewData["UserEmail"]?.ToString()?.Substring(0, 1).ToUpper() ?? "T")
                    </div>
                    <!-- User Menu Dropdown -->
                    <div class="absolute bottom-full mb-2 left-0 w-56 bg-white rounded-lg shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                        <div class="py-2">
                            <!-- User Email -->
                            <div class="px-4 py-2 text-sm text-gray-500 border-b border-gray-200">
                                @(ViewData["UserEmail"]?.ToString() ?? "")
                            </div>
                            <!-- Manage Superusers -->
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                <i class="fas fa-shield-alt w-5 text-gray-600"></i>
                                <span class="ml-3">Manage superusers</span>
                            </a>
                            <!-- Logout -->
                            <form asp-action="Logout" asp-controller="Auth" method="post" class="m-0">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors text-left">
                                    <i class="fas fa-sign-out-alt w-5 text-gray-600"></i>
                                    <span class="ml-3">Sair</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden bg-white">
        <!-- Header -->
        <div class="px-8 py-5 border-b border-gray-200 flex justify-between items-center">
            <div class="flex items-center gap-3">
                @{
                    var breadcrumbStageKey = ViewData["CurrentStage"]?.ToString() ?? "hml";
                    var breadcrumbStageObj = stagesList.FirstOrDefault(s => s.Key == breadcrumbStageKey);
                }
                <span class="text-gray-400 text-base">@(breadcrumbStageObj?.Label ?? "HML")</span>
                <span class="text-gray-400 text-base">/</span>
                <span class="text-gray-400 text-base">Collections</span>
                <span class="text-gray-400 text-base">/</span>
                <a asp-action="Edit" asp-controller="Collections" asp-route-id="@Model.Id" class="text-gray-400 text-base hover:text-gray-600">@(string.IsNullOrEmpty(Model.Label) ? Model.Name : Model.Label)</a>
                <span class="text-gray-400 text-base">/</span>
                <strong class="text-gray-900 text-base">Migrate</strong>
            </div>
            <div class="flex gap-3">
                <a asp-action="Edit" asp-controller="Collections" asp-route-id="@Model.Id" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </a>
                <button id="executeMigrationBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                    Execute Migration
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <div class="flex-1 overflow-y-auto px-8 py-6">
            <div class="max-w-4xl mx-auto">
                <!-- Migration Parameters -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Migration Parameters</h3>
                    
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <!-- Current Stage -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Current Stage <span class="text-gray-400">(read-only)</span>
                            </label>
                            <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold text-gray-900">@(currentStageObj?.Label ?? "HML")</div>
                                        <div class="text-xs text-gray-500">@(currentStageObj?.Description ?? "")</div>
                                    </div>
                                    <div class="w-8 h-8 border-2 border-gray-300 rounded-lg flex items-center justify-center">
                                        <span class="text-gray-700 font-bold text-sm">@(currentStageObj?.Letter ?? "H")</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Arrow -->
                        <div class="flex items-center justify-center">
                            <i class="fas fa-arrow-right text-4xl text-gray-400 mt-6"></i>
                        </div>

                        <!-- Target Stage -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Target Stage <span class="text-red-500">*</span>
                            </label>
                            <select id="targetStageSelect" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select target stage...</option>
                                @foreach (var stage in stagesList.Where(s => s.Key != currentStageKey))
                                {
                                    <option value="@stage.Key" data-label="@stage.Label" data-letter="@stage.Letter" data-description="@stage.Description">
                                        @stage.Label - @stage.Description
                                    </option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Collection Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Collection System Name <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="collectionNameSelect"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            disabled
                        >
                            <option value="">Select target stage first...</option>
                            <option value="@Model.Name" selected>@Model.Name (current collection)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select an existing collection from the target stage or keep the current name</p>
                    </div>
                </div>

                <!-- Migration Status -->
                <div id="migrationStatusSection" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            Migration Status
                        </h3>
                        <div id="migrationStatusSummary" class="text-sm text-gray-700">
                            <!-- Summary content will be inserted here -->
                        </div>
                    </div>

                    <!-- Fields Comparison -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Source Collection Fields -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-database text-gray-600 mr-2"></i>
                                Source Collection Fields
                            </h4>
                            <div id="sourceFieldsList" class="space-y-2">
                                <!-- Source fields will be inserted here -->
                            </div>
                        </div>

                        <!-- Target Collection Fields -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-database text-gray-600 mr-2"></i>
                                Target Collection Fields
                            </h4>
                            <div id="targetFieldsList" class="space-y-2">
                                <!-- Target fields will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stage Selection Modal -->
<div id="stageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-80">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Select Stage</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-2">
            @foreach (var stageItem in stagesList)
            {
                <form asp-action="UpdateStage" asp-controller="Collections" method="post" class="m-0">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="stage" value="@stageItem.Key" />
                    <button type="submit" class="w-full px-4 py-3 text-left border-2 @(ViewData["CurrentStage"]?.ToString() == stageItem.Key ? "border-black bg-gray-50" : "border-gray-200") rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold text-gray-900">@stageItem.Label</div>
                                <div class="text-xs text-gray-500">@stageItem.Description</div>
                            </div>
                            <div class="w-8 h-8 border-2 border-gray-300 rounded-lg flex items-center justify-center">
                                <span class="text-gray-700 font-bold text-sm">@stageItem.Letter</span>
                            </div>
                        </div>
                    </button>
                </form>
            }
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const collectionId = '@Model.Id';
        const currentCollectionName = '@Model.Name';
        const targetStageSelect = document.getElementById('targetStageSelect');
        const collectionNameSelect = document.getElementById('collectionNameSelect');
        const migrationStatusSection = document.getElementById('migrationStatusSection');
        const migrationStatusContent = document.getElementById('migrationStatusContent');
        const executeMigrationBtn = document.getElementById('executeMigrationBtn');

        // Load field types from server
        const dbFieldTypes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewData["FieldTypes"]));
        
        // Field type helper function
        function getFieldIcon(type) {
            const ft = dbFieldTypes ? dbFieldTypes.find(ft => ft.Type === type || ft.type === type) : null;
            return ft ? (ft.Icon || ft.icon || 'fas fa-font') : 'fas fa-font';
        }

        let currentMigrationData = null;
        const currentStage = '@ViewData["CurrentStage"]';

        // Load collections from current stage
        async function loadCurrentStageCollections() {
            try {
                const response = await fetch(`/Collections/GetCollectionsByStage?stage=${currentStage}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const result = await response.json();

                if (result.success && result.collections) {
                    collectionNameSelect.innerHTML = '';
                    
                    // Add option to use current collection name
                    const currentOption = document.createElement('option');
                    currentOption.value = currentCollectionName;
                    currentOption.textContent = currentCollectionName + ' (current collection)';
                    currentOption.selected = true;
                    collectionNameSelect.appendChild(currentOption);

                    // Add existing collections from current stage
                    if (result.collections.length > 0) {
                        const separator = document.createElement('option');
                        separator.disabled = true;
                        separator.textContent = '─────────────────────────';
                        collectionNameSelect.appendChild(separator);

                        result.collections.forEach(collection => {
                            const option = document.createElement('option');
                            option.value = collection.name || collection.Name;
                            const label = collection.label || collection.Label;
                            option.textContent = label 
                                ? `${collection.name || collection.Name} (${label})` 
                                : (collection.name || collection.Name);
                            collectionNameSelect.appendChild(option);
                        });
                    }

                    collectionNameSelect.disabled = false;
                } else {
                    collectionNameSelect.innerHTML = '<option value="">Failed to load collections</option>';
                    collectionNameSelect.disabled = true;
                }
            } catch (error) {
                console.error('Error loading collections:', error);
                collectionNameSelect.innerHTML = '<option value="">Error loading collections</option>';
                collectionNameSelect.disabled = true;
            }
        }

        // Check migration status whenever parameters change
        async function checkMigrationStatus() {
            const targetStage = targetStageSelect.value;
            const collectionName = collectionNameSelect.value.trim();

            if (!targetStage || !collectionName) {
                migrationStatusSection.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`/Collections/${collectionId}/CheckMigration?targetStage=${targetStage}&collectionName=${encodeURIComponent(collectionName)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const result = await response.json();
                currentMigrationData = result;

                if (result.success) {
                    migrationStatusSection.classList.remove('hidden');
                    
                    // Render summary
                    let summaryHtml = '';
                    if (result.exists) {
                        summaryHtml = '<div class="flex items-center">';
                        summaryHtml += '<i class="fas fa-exclamation-triangle text-yellow-600 text-lg mr-2"></i>';
                        summaryHtml += '<div>';
                        summaryHtml += '<span class="font-semibold">Collection Already Exists</span>';
                        summaryHtml += '<span class="text-gray-600"> - ';
                        if (result.newFields && result.newFields.length > 0) {
                            summaryHtml += result.newFields.length + ' new field(s) will be added';
                        } else {
                            summaryHtml += 'Collections are identical';
                        }
                        summaryHtml += '</span>';
                        summaryHtml += '</div>';
                        summaryHtml += '</div>';
                    } else {
                        summaryHtml = '<div class="flex items-center">';
                        summaryHtml += '<i class="fas fa-check-circle text-green-600 text-lg mr-2"></i>';
                        summaryHtml += '<div>';
                        summaryHtml += '<span class="font-semibold">New Collection</span>';
                        summaryHtml += '<span class="text-gray-600"> - The entire collection will be created with all its fields</span>';
                        summaryHtml += '</div>';
                        summaryHtml += '</div>';
                    }
                    document.getElementById('migrationStatusSummary').innerHTML = summaryHtml;

                    // Render source fields
                    let sourceFieldsHtml = '';
                    if (result.sourceFields && result.sourceFields.length > 0) {
                        result.sourceFields.forEach(field => {
                            const isNew = result.newFields && result.newFields.some(nf => 
                                (nf.name || nf.Name) === (field.name || field.Name)
                            );
                            const fieldType = field.type || field.Type;
                            const fieldIcon = getFieldIcon(fieldType);
                            
                            sourceFieldsHtml += '<div class="flex items-center gap-2 p-3 rounded ' + 
                                (isNew ? 'bg-green-50 border border-green-200' : 'bg-gray-50') + '">';
                            if (isNew) {
                                sourceFieldsHtml += '<i class="fas fa-plus-circle text-green-600"></i>';
                            } else {
                                sourceFieldsHtml += '<i class="fas fa-circle text-gray-400 text-xs"></i>';
                            }
                            sourceFieldsHtml += '<i class="' + fieldIcon + ' text-gray-600"></i>';
                            sourceFieldsHtml += '<div class="flex-1">';
                            sourceFieldsHtml += '<div class="font-mono text-sm font-semibold">' + (field.name || field.Name) + '</div>';
                            if (field.label || field.Label) {
                                sourceFieldsHtml += '<div class="text-xs text-gray-500">' + (field.label || field.Label) + '</div>';
                            }
                            sourceFieldsHtml += '</div>';
                            sourceFieldsHtml += '<span class="text-xs px-2 py-1 bg-white border border-gray-300 rounded font-mono">' + fieldType + '</span>';
                            sourceFieldsHtml += '</div>';
                        });
                    } else {
                        sourceFieldsHtml = '<p class="text-sm text-gray-500 text-center py-4">No fields</p>';
                    }
                    document.getElementById('sourceFieldsList').innerHTML = sourceFieldsHtml;

                    // Render target fields
                    let targetFieldsHtml = '';
                    if (result.exists && result.targetFields && result.targetFields.length > 0) {
                        result.targetFields.forEach(field => {
                            const fieldType = field.type || field.Type;
                            const fieldIcon = getFieldIcon(fieldType);
                            
                            targetFieldsHtml += '<div class="flex items-center gap-2 p-3 rounded bg-gray-50">';
                            targetFieldsHtml += '<i class="fas fa-circle text-gray-400 text-xs"></i>';
                            targetFieldsHtml += '<i class="' + fieldIcon + ' text-gray-600"></i>';
                            targetFieldsHtml += '<div class="flex-1">';
                            targetFieldsHtml += '<div class="font-mono text-sm font-semibold">' + (field.name || field.Name) + '</div>';
                            if (field.label || field.Label) {
                                targetFieldsHtml += '<div class="text-xs text-gray-500">' + (field.label || field.Label) + '</div>';
                            }
                            targetFieldsHtml += '</div>';
                            targetFieldsHtml += '<span class="text-xs px-2 py-1 bg-white border border-gray-300 rounded font-mono">' + fieldType + '</span>';
                            targetFieldsHtml += '</div>';
                        });
                        
                        // Add new fields that will be added
                        if (result.newFields && result.newFields.length > 0) {
                            result.newFields.forEach(field => {
                                const fieldType = field.type || field.Type;
                                const fieldIcon = getFieldIcon(fieldType);
                                
                                targetFieldsHtml += '<div class="flex items-center gap-2 p-3 rounded bg-green-50 border border-green-200 border-dashed">';
                                targetFieldsHtml += '<i class="fas fa-arrow-down text-green-600"></i>';
                                targetFieldsHtml += '<i class="' + fieldIcon + ' text-green-600"></i>';
                                targetFieldsHtml += '<div class="flex-1">';
                                targetFieldsHtml += '<div class="font-mono text-sm font-semibold text-green-700">' + (field.name || field.Name) + '</div>';
                                if (field.label || field.Label) {
                                    targetFieldsHtml += '<div class="text-xs text-green-600">' + (field.label || field.Label) + '</div>';
                                }
                                targetFieldsHtml += '</div>';
                                targetFieldsHtml += '<span class="text-xs px-2 py-1 bg-white border border-green-300 rounded font-mono text-green-700">' + fieldType + '</span>';
                                targetFieldsHtml += '</div>';
                            });
                        }
                    } else if (result.exists) {
                        targetFieldsHtml = '<p class="text-sm text-gray-500 text-center py-4">No fields</p>';
                    } else {
                        // Collection doesn't exist - show that all fields will be created
                        targetFieldsHtml = '<div class="p-4 bg-blue-50 border border-blue-200 rounded text-center">';
                        targetFieldsHtml += '<i class="fas fa-info-circle text-blue-600 mb-2 text-lg"></i>';
                        targetFieldsHtml += '<p class="text-sm text-gray-700 font-semibold">Collection does not exist yet</p>';
                        targetFieldsHtml += '<p class="text-xs text-gray-500 mt-1">All ' + result.sourceFields.length + ' field(s) from source will be created</p>';
                        targetFieldsHtml += '</div>';
                    }
                    document.getElementById('targetFieldsList').innerHTML = targetFieldsHtml;
                } else {
                    migrationStatusSection.classList.add('hidden');
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message || 'Failed to check migration status',
                        confirmButtonColor: '#000'
                    });
                }
            } catch (error) {
                console.error('Error checking migration:', error);
                migrationStatusSection.classList.add('hidden');
            }
        }

        // Load collections from current stage on init
        loadCurrentStageCollections();

        // Event listeners for parameter changes
        targetStageSelect.addEventListener('change', checkMigrationStatus);

        collectionNameSelect.addEventListener('change', checkMigrationStatus);

        // Execute migration
        executeMigrationBtn.addEventListener('click', async function() {
            const targetStage = targetStageSelect.value;
            const collectionName = collectionNameSelect.value.trim();

            if (!targetStage) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please select a target stage',
                    confirmButtonColor: '#000'
                });
                return;
            }

            if (!collectionName) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please select a collection name',
                    confirmButtonColor: '#000'
                });
                return;
            }

            try {
                const response = await fetch(`/Collections/${collectionId}/Migrate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        targetStage: targetStage,
                        collectionName: collectionName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message || 'Migration completed successfully!',
                        confirmButtonColor: '#000'
                    }).then(() => {
                        window.location.href = '@Url.Action("Edit", "Collections", new { id = Model.Id })';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message || 'Migration failed',
                        confirmButtonColor: '#000'
                    });
                }
            } catch (error) {
                console.error('Error executing migration:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to execute migration. Please try again.',
                    confirmButtonColor: '#000'
                });
            }
        });

        // Stage modal functionality
        const stageSelector = document.getElementById('stageSelector');
        const stageModal = document.getElementById('stageModal');
        const closeModal = document.getElementById('closeModal');

        if (stageSelector && stageModal) {
            stageSelector.addEventListener('click', function() {
                stageModal.classList.remove('hidden');
            });
        }

        if (closeModal && stageModal) {
            closeModal.addEventListener('click', function() {
                stageModal.classList.add('hidden');
            });
        }

        if (stageModal) {
            stageModal.addEventListener('click', function(e) {
                if (e.target === stageModal) {
                    stageModal.classList.add('hidden');
                }
            });
        }
    });
</script>


